name: ci

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

jobs:
  linux:
    runs-on: ubuntu-latest
    name: linux (${{ matrix.name }})
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: ubuntu
            container: ubuntu:latest
          - name: alpine
            container: alpine:latest
          - name: rhel
            container: registry.access.redhat.com/ubi9/ubi:latest
    container:
      image: ${{ matrix.container }}
    timeout-minutes: 15
    defaults:
      run:
        shell: sh
    steps:
      - name: Install OS dependencies
        run: |
          set -eu
          CURL_PKG=""
          ICU_PKG=""
          if ! command -v curl >/dev/null 2>&1; then
            CURL_PKG="curl"
          fi
          if command -v apt-get >/dev/null 2>&1; then
            export DEBIAN_FRONTEND=noninteractive
            apt-get update
            ICU_PKG="$(apt-cache pkgnames | awk '/^libicu[0-9]+$/{print}' | sort -V | tail -n 1)"
            if [ -z "${ICU_PKG}" ]; then
              ICU_PKG="libicu-dev"
            fi
            apt-get install -y --no-install-recommends \
              ca-certificates \
              ${CURL_PKG} \
              git \
              gzip \
              ${ICU_PKG} \
              python3 \
              python3-packaging \
              tar
            rm -rf /var/lib/apt/lists/*
          elif command -v apk >/dev/null 2>&1; then
            ICU_PKG="icu-libs"
            apk add --no-cache \
              ca-certificates \
              ${CURL_PKG} \
              git \
              gzip \
              ${ICU_PKG} \
              python3 \
              py3-packaging \
              tar
          elif command -v microdnf >/dev/null 2>&1; then
            if [ -n "${CURL_PKG}" ]; then
              CURL_PKG="curl-minimal"
            fi
            ICU_PKG="libicu"
            microdnf install -y \
              ca-certificates \
              ${CURL_PKG} \
              git \
              gzip \
              ${ICU_PKG} \
              python3 \
              python3-packaging \
              tar
            microdnf clean all
          elif command -v dnf >/dev/null 2>&1; then
            ICU_PKG="libicu"
            dnf install -y \
              ca-certificates \
              ${CURL_PKG} \
              git \
              gzip \
              ${ICU_PKG} \
              python3 \
              python3-packaging \
              tar
            dnf clean all
          else
            echo "ERROR: Unsupported package manager in container" >&2
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@main

      - name: Run dry-run test
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -eu
          chmod +x upstall-pwsh-linux.sh
          ./upstall-pwsh-linux.sh --dry-run

      - name: Install PowerShell
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -eu
          ./upstall-pwsh-linux.sh --force

      - name: Verify installation
        run: |
          set -eu
          if ! command -v pwsh >/dev/null 2>&1; then
            echo "ERROR: pwsh command not found after installation" >&2
            exit 1
          fi
          echo "PowerShell installed successfully"
          pwsh -NoLogo -NoProfile -Command '
            Write-Host "PowerShell Version: $($PSVersionTable.PSVersion.ToString())"
            Write-Host "Edition: $($PSVersionTable.PSEdition)"
            Write-Host "OS: $($PSVersionTable.OS)"
          '

      - name: Uninstall PowerShell
        run: |
          set -eu
          ./upstall-pwsh-linux.sh --uninstall || echo "Uninstall completed with warnings"

      - name: Verify uninstallation
        run: |
          set -eu
          if command -v pwsh >/dev/null 2>&1; then
            echo "Note: pwsh still available (may be system-installed version)"
            pwsh -NoLogo -NoProfile -Command 'Write-Host "Remaining version: $($PSVersionTable.PSVersion)"'
          else
            echo "PowerShell uninstalled successfully"
          fi

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@main
        with:
          name: linux-logs-${{ matrix.name }}
          path: ~/.local/share/powershell/
          if-no-files-found: ignore

  macos:
    runs-on: macos-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@main

      - name: Run dry-run test
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          chmod +x upstall-pwsh-macos.sh
          ./upstall-pwsh-macos.sh --dry-run

      - name: Install PowerShell
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          sudo env GITHUB_TOKEN="${GITHUB_TOKEN}" ./upstall-pwsh-macos.sh --force

      - name: Verify installation
        run: |
          set -euo pipefail
          if ! command -v pwsh >/dev/null 2>&1; then
            echo "ERROR: pwsh command not found after installation" >&2
            exit 1
          fi
          echo "PowerShell installed successfully"
          pwsh -NoLogo -NoProfile -Command '
            Write-Host "PowerShell Version: $($PSVersionTable.PSVersion.ToString())"
            Write-Host "Edition: $($PSVersionTable.PSEdition)"
            Write-Host "OS: $($PSVersionTable.OS)"
          '

      - name: Uninstall PowerShell
        run: |
          set -euo pipefail
          sudo ./upstall-pwsh-macos.sh --uninstall || echo "Uninstall completed with warnings"

      - name: Verify uninstallation
        run: |
          set -euo pipefail
          if command -v pwsh >/dev/null 2>&1; then
            echo "Note: pwsh still available (may be system-installed version)"
            pwsh -NoLogo -NoProfile -Command 'Write-Host "Remaining version: $($PSVersionTable.PSVersion)"'
          else
            echo "PowerShell uninstalled successfully"
          fi

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@main
        with:
          name: macos-logs
          path: ~/.local/share/powershell/
          if-no-files-found: ignore

  windows:
    runs-on: windows-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@main

      - name: Capture pre-install state
        shell: powershell
        run: |
          $ErrorActionPreference = 'Stop'
          Write-Host "Pre-install PowerShell state:"
          Get-Command pwsh -ErrorAction SilentlyContinue | Select-Object Name, Version, Source | Format-List
          $preInstallPath = (Get-Command pwsh -ErrorAction SilentlyContinue)
          if ($preInstallPath) {
            $env:PRE_INSTALL_PWSH_PATH = $preInstallPath.Source
          } else {
            $env:PRE_INSTALL_PWSH_PATH = ''
          }
          "PRE_INSTALL_PWSH_PATH=$env:PRE_INSTALL_PWSH_PATH" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Run dry-run test
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: powershell
        run: |
          $ErrorActionPreference = 'Stop'
          Set-StrictMode -Version Latest
          .\upstall-pwsh-windows.ps1 -WhatIf -Verbose

      - name: Install PowerShell
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: powershell
        run: |
          $ErrorActionPreference = 'Stop'
          Set-StrictMode -Version Latest
          .\upstall-pwsh-windows.ps1 -Force -Verbose

      - name: Verify installation
        shell: powershell
        run: |
          $ErrorActionPreference = 'Stop'
          if (-not (Get-Command pwsh -ErrorAction SilentlyContinue)) {
            Write-Error "ERROR: pwsh command not found after installation"
            exit 1
          }
          Write-Host "PowerShell installed successfully"
          # Run pwsh to verify it works and show version
          & pwsh -NoLogo -NoProfile -Command '
            Write-Host "PowerShell Version: $($PSVersionTable.PSVersion.ToString())"
            Write-Host "Edition: $($PSVersionTable.PSEdition)"
            Write-Host "OS: $($PSVersionTable.OS)"
          '

      - name: Uninstall PowerShell
        shell: powershell
        run: |
          $ErrorActionPreference = 'Continue'
          Set-StrictMode -Off
          .\upstall-pwsh-windows.ps1 -Uninstall -Verbose
          if ($LASTEXITCODE -and $LASTEXITCODE -ne 0) {
            Write-Host "Uninstall completed with warnings (exit code: $LASTEXITCODE)"
          }

      - name: Verify uninstallation
        shell: powershell
        run: |
          $ErrorActionPreference = 'Stop'
          $postUninstallCmd = Get-Command pwsh -ErrorAction SilentlyContinue
          $postUninstallPath = if ($postUninstallCmd) { $postUninstallCmd.Source } else { $null }

          # If pwsh still exists, verify it's the same pre-existing installation
          if ($postUninstallPath) {
            Write-Host "pwsh found at: $postUninstallPath"
            if ($env:PRE_INSTALL_PWSH_PATH) {
              if ($postUninstallPath -eq $env:PRE_INSTALL_PWSH_PATH) {
                Write-Host "OK: Only pre-existing PowerShell remains (system installation)"
              } else {
                Write-Host "Note: Different pwsh version found after uninstall"
                Write-Host "  Pre-install: $env:PRE_INSTALL_PWSH_PATH"
                Write-Host "  Current: $postUninstallPath"
              }
            } else {
              Write-Host "Note: pwsh present after uninstall (may be system-installed version)"
            }
          } else {
            Write-Host "PowerShell uninstalled successfully (pwsh command not found)"
          }

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@main
        with:
          name: windows-logs
          path: ${{ runner.temp }}/*.log
          if-no-files-found: ignore
